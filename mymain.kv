#:kivy 2.0.0
#: import WipeTransition kivy.uix.screenmanager.WipeTransition

WindowManger:
    transition: WipeTransition()

    id: screen_manager

    main_menu: main_menu
    menu: menu
    team: team
    shop: shop
    skills_window: skills_window
    fight: fight
    game_over: game_over
    battle_result: battle_result
    character_creation: character_creation
    add_new_character: add_new_character
    map: map
    tutorial: tutorial
    end: end
    settings_menu: settings_menu

    Main_Menu:
        id: main_menu
        name: "main_menu"
        manager: screen_manager
    Menu:
        id: menu
        name: "menu"
        manager: screen_manager
    Team:
        id: team
        name: "team"
        manager: screen_manager
    Shop:
        id: shop
        name: "shop"
        manager: screen_manager
    Skills_Window:
        id: skills_window
        name: "skills"
        manager: screen_manager
    Fight:
        id: fight
        name: "fight"
        manager: screen_manager
    Game_Over:
        id: game_over
        name: "game_over"
        manager: screen_manager
    Battle_Result:
        id: battle_result
        name: "battle_result"
        manager: screen_manager
    Character_Creation:
        id: character_creation
        name: "character_creation"
        manager: screen_manager
    Add_New_Character:
        id: add_new_character
        name: "add_new_character"
        manager: screen_manager
    Map:
        id: map
        name: "map"
        manager: screen_manager
    Tutorial:
        id: tutorial
        name:"tutorial"
        manager: screen_manager
    End:
        id: end
        name: "end"
        manager: screen_manager
    Settings_menu:
        id: settings_menu
        name: "settings_menu"
        manager: screen_manager

<Menu>:
    name: "menu"
    on_pre_enter: root.setup_window()
    size_hint: 1,1
    Image:
        size_hint: 1,1
        allow_stretch: True
        fit_mode: "fill"
        source: "graphics/stage1_background.png"
    StageProgressBar:
        max: 10
        value: root.bar
    Label:
        pos_hint: {"center_x": 0.88, "center_y": 0.5}
        font_size: 30
        text: root.text

<Shop>:
    name: "shop"
    on_pre_enter: root.setup_window()
    size_hint: 1, 1
        
<Skills_Window>:
    name: "skills"
    on_pre_enter: root.setup_window()
    size_hint: None, None

<Team>:
    name: "team"
    on_pre_enter: root.setup_window()
    size_hint: 1, 1

<Fight>:
    name: "fight"
    on_pre_enter: root.start_fight_setup()
    Image:
        size_hint: None,None
        allow_stretch: True
        size: 1540,950
        source: "graphics/battle_background.png"
        pos: 0,0
    Button:
        id: attack
        on_release: root.action_attack()
        pos: 50,200
        size_hint: 0.065,0.10
        background_normal: "graphics/attack_button.png"
        background_disabled_normal: "graphics/attack_button_disabled.png"

    Button:
        id: spells
        on_release: root.action_spells()
        pos: 50,320
        size_hint: 0.065,0.10
        background_normal: "graphics/magic_button.png"
        background_disabled_normal: "graphics/magic_button_disabled.png"

    Button:
        id: defend
        on_release: root.action_defend()
        pos: 50,440
        size_hint: 0.065,0.10
        background_normal: "graphics/defend_button.png"
        background_disabled_normal: "graphics/defend_button_disabled.png"
    
    Button:
        id: potion
        on_release: root.action_potion()
        pos: 50,560
        size_hint: 0.065,0.10
        background_normal: "graphics/potion_button.png"
        background_disabled_normal: "graphics/potion_button_disabled.png"

<Game_Over>:
    name: "game_over"
    size_hint: None, None
    Image:
        size_hint: None,None
        allow_stretch: True
        size: 1540,950
        source: "graphics/game_over_background.png"
        pos: 0,0
    Button:
        on_release: app.root.current = "main_menu"
        pos: 450,300
        size: 200,150
        size_hint: None,None
        text: "Wróc do menu"
        font_size: 25
        background_normal:"graphics/target_button.png"
    Button:
        on_release: app.root.current = "menu"
        pos: 850,300
        size: 200,150
        size_hint: None,None
        text: "Wczytaj grę"
        font_size: 25
        background_normal:"graphics/target_button.png"
    Label:
        text: "PORAŻKA\nZOSTAŁEŚ POKONANY"
        font_size: 45
        pos: 0,200
        halign: "center"
    Label:
        text: "Nie udało ci się wydostać z nieskończonego lochu.\nWczytaj grę aby spróbować jeszcze raz"
        font_size: 30
        pos: 0,100
        halign: "center"
<End>:
    name: "end"
    size_hint: None, None
    Image:
        size_hint: None,None
        allow_stretch: True
        size: 1540,950
        source: "graphics/plain_background.png"
        pos: 0,0
    Button:
        on_release: app.root.current = "main_menu"
        pos: 450,300
        size: 200,150
        size_hint: None,None
        text: "Wróc do menu"
        font_size: 25
        background_normal:"graphics/target_button.png"
    Button:
        on_release: app.root.current = "menu"
        pos: 850,300
        size: 200,150
        size_hint: None,None
        text: "Graj dalej"
        font_size: 25
        background_normal:"graphics/target_button.png"
    Label:
        text: "GRATULACJE"
        font_size: 45
        pos: 0,200
        halign: "center"
    Label:
        text: "Udało ci się pokonać władcę lochu i odzyskać wolność.\nJeśli chcesz możesz grać dalej wczytując grę"
        font_size: 25
        pos: 0,100
        halign: "center"
<Character_Creation>:
    name: "character_creation"
    size_hint: 1,1
    on_pre_enter: root.setup_window()
<Add_New_Character>:
    name: "add_new_character"
    on_pre_enter: root.setup_window()
<Map>:
    name: "map"
    on_pre_enter: root.setup_window()
<Main_Menu>:
    name: "main_menu"
    size_hint: 1, 1
    Image:
        size_hint: 1, 1
        allow_stretch: True
        fit_mode: "fill"
        source: "graphics/plain_background.png"
        pos: 0,0
    Image:
        size_hint: 1,1
        pos_hint: {"center_x": 0.5, "center_y": 0.8}
        source: "graphics/title.png"

    Button:
        on_release: app.root.current = "character_creation"
        pos_hint: {"center_x": 0.5, "center_y": 0.55}
        size: 200,130
        size_hint: None,None
        text: "Nowa Gra"
        font_size: 25
        background_normal:"graphics/target_button.png"
    Button:
        on_release: root.load_game()
        pos_hint: {"center_x": 0.5, "center_y": 0.40}
        size: 200,130
        size_hint: None,None
        text: "Wczytaj grę"
        font_size: 25
        background_normal:"graphics/target_button.png"
    Button:
        on_release: app.root.current = "tutorial"
        pos_hint: {"center_x": 0.5, "center_y": 0.25}
        size: 200,130
        size_hint: None,None
        text: "Jak grać?"
        font_size: 25
        background_normal:"graphics/target_button.png"
    Button:
        on_release: root.exit()
        pos_hint: {"center_x": 0.5, "center_y": 0.10}
        size: 200,130
        size_hint: None,None
        text: "Wyjście"
        font_size: 25
        background_normal:"graphics/target_button.png"
<Tutorial>:
    name:"tutorial"
    size_hint: None,None
    on_pre_enter: root.start()
    Image:
        size_hint: None,None
        allow_stretch: True
        size: 1540,950
        source: "graphics/plain_background.png"
        pos: 0,0
    Image:
        id: help_image
        pos: 200,20
        source: ""
        size: 1100,600
        size_hint: None,None
    Button:
        text: "Start"
        pos: 50,750
        size: 170,80
        on_release: root.start()
        size_hint: None,None
        font_size: 23
        background_normal:"graphics/target_button.png"
    Button:
        text: "Ekwipunek\nSklep"
        pos: 250,750
        size: 170,80
        on_release: root.inventory_shop()
        size_hint: None,None
        font_size: 23
        background_normal:"graphics/target_button.png"
    Button:
        text: "Rozwój postaci"
        pos: 450,750
        size: 170,80
        on_release: root.progress()
        size_hint: None,None
        font_size: 23
        background_normal:"graphics/target_button.png"
    Button:
        text: "Walka"
        pos: 650,750
        size: 170,80
        on_release: root.fight()
        size_hint: None,None
        font_size: 23
        background_normal:"graphics/target_button.png"
    Button:
        text: "Powrót"
        pos: 850,750
        size: 170,80
        on_release: app.root.current = "main_menu"
        size_hint: None,None
        font_size: 23
        background_normal:"graphics/target_button.png"
    Label:
        id: help_text
        size_hint: None,None
        pos: 700,650
        font_size: 20
        halign: "left"
        valign: "middle"
<Settings_menu>:
    name: "main_menu"
    size_hint: None, None
    Image:
        size_hint: None,None
        allow_stretch: True
        size: 1540,950
        source: "graphics/plain_background.png"
        pos: 0,0
    Image:
        pos: 450,570
        size_hint: None,None
        allow_stretch: True
        size: 600,300
        source: "graphics/title.png"

    Button:
        on_release: app.root.current = "menu"
        pos: 650,460
        size: 200,130
        size_hint: None,None
        text: "Powrót do gry"
        font_size: 25
        background_normal:"graphics/target_button.png"
    Button:
        on_release: root.save_game()
        pos: 650,310
        size: 200,130
        size_hint: None,None
        text: "Zapisz grę"
        font_size: 25
        background_normal:"graphics/target_button.png"
    Button:
        on_release: app.root.current = "main_menu"
        pos: 650,160
        size: 200,130
        size_hint: None,None
        text: "Wyjście do menu"
        font_size: 25
        background_normal:"graphics/target_button.png"
    Button:
        on_release: root.exit()
        pos: 650,10
        size: 200,130
        size_hint: None,None
        text: "Wyjdź z gry"
        font_size: 25
        background_normal:"graphics/target_button.png"
<Battle_Result>:
    name: "battle_result"
    size_hint: None, None
    on_pre_enter: root.setup_window()
        
<Character_Sprite>:
    size_hint: 0.25,0.41
    canvas:
        Rectangle:
            source: root.head
            size: self.size
            pos: self.pos
        Rectangle:
            source: root.sprite
            size: self.size
            pos: self.pos
        Rectangle:
            source: root.weapon
            size: self.size
            pos: self.pos
        Rectangle:
            source: root.effect
            size: self.size
            pos: self.pos

<Enemy_Sprite>:
    size_hint: 0.25,0.41
    canvas:
        Rectangle:
            source: root.sprite
            size: self.size
            pos: self.pos
        Rectangle:
            source: root.effect
            size: self.size
            pos: self.pos

<ItemSlot>:
    drag_rectangle: self.x, self.y, self.width, self.height
    drag_timeout: 10000000
    drag_distance: 0
    size_hint: None, None   
    size: 65,65
    canvas:
        Color: 
            rgba: 1,1,1,1
        Rectangle:
            pos: self.pos
            size: self.size
            source: self.sprite

<SkillSlot>:
    size_hint: None, None   
    size: 50,50
    canvas:
        Color: 
            rgba: 1,1,1,1
        Rectangle:
            pos: self.pos
            size: self.size
            source: self.sprite

<Skill_Line>:
    canvas:
        Color: 
            rgba: 1,1,1,1
        Line:
            width: 4
            points: self.points
                  
<Skill_List_Pop_Up>:
    list: list
    orientation: 'vertical'
    size_hint_y: 0.6
    pos_hint: {"y":.35}
    ScrollView:
        size_hint_y: 0.6
        pos_hint: {"x":0.17, "y":0.4}
        do_scroll_x: False
        do_scroll_y: True
        GridLayout:
            id: list
            size:(root.width, root.height)
            size_hint_x: None
            size_hint_y: None
            cols: 1
            height: self.minimum_height
            padding: 0,85
            
<Stat_Button>:
    size_hint: None, None
    size: 25,25
    background_normal: "graphics/stat_up_button.png"

<-HPBar>:
    canvas.before:
        PushMatrix
        Rotate:
            angle: 90
            origin: self.center
    canvas.after:
        PopMatrix
    canvas:
        Color:
            rgb: 1, 1, 1
        BorderImage:
            border: (12, 12, 12, 12)
            pos: self.x, self.center_y - 12
            size: self.width, 48
            source: 'graphics/pb_bg.png'
        BorderImage:
            id: border_image
            border: [int(min(self.width * (self.value / float(self.max)) if self.max else 0, 12))] * 4
            pos: self.x, self.center_y - 12
            size: self.width * (self.value / float(self.max)) if self.max else 0, 48
            source: 'graphics/pb_hp.png'

<-MPBar>:
    canvas.before:
        PushMatrix
        Rotate:
            angle: 90
            origin: self.center
    canvas.after:
        PopMatrix
    canvas:
        Color:
            rgb: 1, 1, 1
        BorderImage:
            border: (12, 12, 12, 12)
            pos: self.x, self.center_y - 12
            size: self.width, 48
            source: 'graphics/pb_bg.png'
        BorderImage:
            border: [int(min(self.width * (self.value / float(self.max)) if self.max else 0, 12))] * 4
            pos: self.x, self.center_y - 12
            size: self.width * (self.value / float(self.max)) if self.max else 0, 48
            source: 'graphics/pb_mp.png'

<-EnemyHPBar>:
    canvas.before:
        PushMatrix
        Rotate:
            angle: 90
            origin: self.center
    canvas.after:
        PopMatrix
    canvas:
        Color:
            rgb: 1, 1, 1
        BorderImage:
            border: (12, 12, 12, 12)
            pos: self.x, self.center_y - 12
            size: self.width, 48
            source: 'graphics/pb_bg.png'
        BorderImage:
            border: [int(min(self.width * (self.value / float(self.max)) if self.max else 0, 12))] * 4
            pos: self.x, self.center_y - 12
            size: self.width * (self.value / float(self.max)) if self.max else 0, 48
            source: 'graphics/pb_hp.png'

<-EXPBar>:
    canvas:
        Color:
            rgb: 1, 1, 1
        BorderImage:
            border: (12, 12, 12, 12)
            pos: self.x, self.center_y - 12
            size: self.width, 40
            source: 'graphics/pb_bg.png'
        BorderImage:
            border: [int(min(self.width * (self.value / float(self.max)) if self.max else 0, 12))] * 4
            pos: self.x, self.center_y - 12
            size: self.width * (self.value / float(self.max)) if self.max else 0, 40
            source: 'graphics/pb_exp.png'

<-StageProgressBar>:
    pos_hint: {"center_x": 0.95, "center_y": 0.5}
    size_hint_x: .40
    canvas.before:
        PushMatrix
        Rotate:
            angle: 90
            origin: self.center
    canvas.after:
        PopMatrix
    canvas:
        Color:
            rgb: 1, 1, 1
        BorderImage:
            border: (12, 12, 12, 12)
            pos: self.x, self.center_y - 12
            size: self.width, 24
            source: 'graphics/pb_bg.png'
        BorderImage:
            id: border_image
            border: [int(min(self.width * (self.value / float(self.max)) if self.max else 0, 12))] * 4
            pos: self.x, self.center_y - 12
            size: self.width * (self.value / float(self.max)) if self.max else 0, 24
            source: 'graphics/pb_stage.png'

<Skill_Record>:
    size_hint: None,None
    size: 340,50
    background_color: (0.58,0.69,0.88,1)
    canvas.before:
        Color:
            rgba: .28, .4, .56, 1
        Line:
            width: 1
            rectangle: self.x, self.y, self.width, self.height
    canvas:
        Color:
            rgba: 1,1,1,1
        Rectangle:
            pos: self.pos
            size: 50,50
            source: self.source
            

<Status_Icon>:
    size_hint: None,None
    size: 20,20
    background_color:
    canvas:
        Color:
            rgba: 1,1,1,1
        Rectangle:
            pos: self.pos
            size: 20,20
            source: self.source

<Switch_Character_Button>:
    size_hint: 0.10,0.06
    background_normal:"graphics/target_button.png"

<Tooltip>:
    padding: 10,10
    text_size: self.width, None
    size_hint: None, None
    height: self.texture_size[1]
    font_size: 27
    color: 0,0,0,1
    width: 500
    canvas.before:
        Color:
            rgba: 0,0,0,0.7
        Rectangle:
            pos: self.pos
            size: self.size